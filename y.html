<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Search with Preview Filter</title>
  <style>
    /* Basic styles for layout and clarity */
    .book { display: flex; margin-bottom: 1rem; }
    .book img { margin-right: 1rem; }
    .book-info { max-width: 600px; }
    .read-button, .navigation { margin-top: 0.5rem; }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #reader {
      display: none;
      position: fixed;
      top: 10%; left: 10%;
      width: 80%; height: 80%;
      background: #fff;
      padding: 1rem;
      overflow: auto;
    }
  </style>
</head>
<body>
  <!-- Overlay, Popup and Reader elements -->
  <div id="overlay"></div>
  <div id="hclPopup" style="display: none;">Popup Content</div>
  <div id="reader"></div>

  <!-- Search Form -->
  <form id="searchForm">
    <input type="text" id="query" placeholder="Search for books" required>
    <button type="submit">Search</button>
  </form>

  <!-- Results & Navigation -->
  <div id="results"></div>
  <div id="navigation"></div>
  <button id="prevPage">Prev</button>
  <button id="nextPage">Next</button>

  <script>
    // Toggle functions using getComputedStyle for more reliable results
    function toggleDropdown(menuId) {
      const dropdown = document.getElementById(menuId);
      const display = window.getComputedStyle(dropdown).display;
      dropdown.style.display = display === "block" ? "none" : "block";
    }

    function togglePopup() {
      const popup = document.getElementById('hclPopup');
      const overlay = document.getElementById('overlay');
      const display = window.getComputedStyle(popup).display;
      const isVisible = display === 'block';
      popup.style.display = isVisible ? 'none' : 'block';
      overlay.style.display = isVisible ? 'none' : 'block';
    }

    function togglereader() {
      const popup = document.getElementById('reader');
      const overlay = document.getElementById('overlay');
      const display = window.getComputedStyle(popup).display;
      const isVisible = display === 'block';
      popup.style.display = isVisible ? 'none' : 'block';
      overlay.style.display = isVisible ? 'none' : 'block';
    }

    // Book search and pagination variables
    let books = [];
    let currentPage = 0;
    const booksPerPage = 10;

    function clearReader() {
      document.getElementById("reader").innerHTML = "";
    }

    // Render the list of books and apply preview filtering
    function renderBooks() {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";
      const start = currentPage * booksPerPage;
      const end = start + booksPerPage;
      const paginatedBooks = books.slice(start, end);

      paginatedBooks.forEach(book => {
        const div = document.createElement("div");
        div.className = "book";

        // Set cover image or a placeholder if not available
        const coverImg = document.createElement("img");
        coverImg.src = book.cover_i 
          ? `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg` 
          : "https://via.placeholder.com/100x150?text=No+Cover";

        const infoDiv = document.createElement("div");
        infoDiv.className = "book-info";
        const title = book.title || "No Title";
        const authors = book.author_name ? book.author_name.join(", ") : "Unknown Author";
        infoDiv.innerHTML = `<h3>${title}</h3><p><strong>Author(s):</strong> ${authors}</p>`;

        // Check if the book has Archive.org data
        if (book.ia && book.ia.length > 0) {
          if (book.has_fulltext) {
            // Full text available: add a "Read" button
            const readBtn = document.createElement("button");
            readBtn.className = "read-button";
            readBtn.textContent = "Read";
            readBtn.addEventListener("click", function() {
              togglereader();
              const iaId = book.ia[0];
              const embedUrl = `https://archive.org/embed/${iaId}?ui=embed`;
              document.getElementById("reader").innerHTML = `
                <button class="close-button" onclick="togglereader()">Close</button>
                <h2>Reading: ${title}</h2>
                <iframe src="${embedUrl}" frameborder="0" allowfullscreen style="width:100%; height:80%;"></iframe>`;
              document.getElementById("reader").scrollIntoView({ behavior: "smooth" });
            });
            infoDiv.appendChild(readBtn);
          } else {
            // Preview-only: show default message and link to details
            const defaultMsg = document.createElement("p");
            defaultMsg.textContent = "This book is available as a preview only.";
            infoDiv.appendChild(defaultMsg);
            const infoLink = document.createElement("a");
            infoLink.href = `https://openlibrary.org${book.key}`;
            infoLink.target = "_blank";
            infoLink.textContent = "View Details";
            infoDiv.appendChild(infoLink);
          }
        } else {
          // No Archive.org data: simply show a "View Details" link
          const infoLink = document.createElement("a");
          infoLink.href = `https://openlibrary.org${book.key}`;
          infoLink.target = "_blank";
          infoLink.textContent = "View Details";
          infoDiv.appendChild(infoLink);
        }

        div.appendChild(coverImg);
        div.appendChild(infoDiv);
        resultsDiv.appendChild(div);
      });

      // Disable/enable pagination buttons based on current page
      document.getElementById("prevPage").disabled = currentPage === 0;
      document.getElementById("nextPage").disabled = end >= books.length;
    }

    // Listen for search form submissions
    document.getElementById("searchForm").addEventListener("submit", function(e) {
      e.preventDefault();
      clearReader();
      search();
    });

    // Search function to fetch book data from Open Library
    function search() {
      const query = document.getElementById("query").value;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "<p>Loading...</p>";

      fetch("https://openlibrary.org/search.json?q=" + encodeURIComponent(query))
        .then(response => response.json())
        .then(data => {
          books = data.docs || [];
          currentPage = 0;
          renderBooks();
          renderPagination();
        })
        .catch(error => {
          resultsDiv.innerHTML = "<p>Error retrieving results.</p>";
          console.error("Error fetching data:", error);
        });
    }

    // Render pagination buttons based on total results
    function renderPagination() {
      const navDiv = document.getElementById("navigation");
      navDiv.innerHTML = "";
      for (let x = 0; x < Math.ceil(books.length / booksPerPage); x++) {
        const nav = document.createElement("button");
        nav.className = "navigation";
        nav.textContent = x + 1;
        nav.value = x;
        nav.addEventListener("click", function() {
          currentPage = parseInt(this.value);
          renderBooks();
        });
        navDiv.appendChild(nav);
      }
    }

    // Previous/Next button event listeners
    document.getElementById("prevPage").addEventListener("click", function() {
      if (currentPage > 0) {
        currentPage--;
        renderBooks();
      }
    });

    document.getElementById("nextPage").addEventListener("click", function() {
      if ((currentPage + 1) * booksPerPage < books.length) {
        currentPage++;
        renderBooks();
      }
    });
  </script>
</body>
</html>
